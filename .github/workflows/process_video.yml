# .github/workflows/process_video.yml - v2.3 å„ªåŒ–ç‰ˆ
name: Enhanced Video Processing with Whisper

on:
  repository_dispatch:
    types: [process_notion_task]
  
  workflow_dispatch:
    inputs:
      notion_page_id:
        description: 'Notion é é¢ ID'
        required: true
        type: string
      original_link:
        description: 'å½±ç‰‡ URL'
        required: true
        type: string
      task_name:
        description: 'ä»»å‹™åç¨±'
        required: true
        type: string
      person_in_charge:
        description: 'è² è²¬äºº'
        required: false
        type: string
      videographer:
        description: 'æ”å½±å¸«'
        required: false
        type: string
      enable_whisper:
        description: 'å•Ÿç”¨ Whisper èªéŸ³è½‰æ–‡å­—'
        required: false
        type: boolean
        default: true
      enable_local_backup:
        description: 'å•Ÿç”¨æœ¬åœ°å‚™ä»½'
        required: false
        type: boolean
        default: true

# è¨­å®šä¸¦è¡Œæ§åˆ¶
concurrency:
  group: notion-video-${{ github.event.client_payload.notion_page_id || github.event.inputs.notion_page_id }}
  cancel-in-progress: false

jobs:
  process-video:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # å¢åŠ æ™‚é–“ä»¥æ”¯æ´ Whisper
    
    steps:
      # æ­¥é©Ÿ 1: æ‹‰å–ç¨‹å¼ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # æ­¥é©Ÿ 2: è¨­å®š Python ç’°å¢ƒ
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # æ­¥é©Ÿ 3: å®‰è£ç³»çµ±ä¾è³´
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libgl1-mesa-glx libglib2.0-0
          
          # å®‰è£ yt-dlp
          sudo wget -q https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -O /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          
          # é©—è­‰å®‰è£
          ffmpeg -version | head -n1
          yt-dlp --version
      
      # æ­¥é©Ÿ 4: å®‰è£ Python ä¾è³´
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # æ­¥é©Ÿ 5: é©—è­‰ç’°å¢ƒè®Šæ•¸
      - name: Validate environment
        run: |
          echo "ğŸ” æª¢æŸ¥ç’°å¢ƒè®Šæ•¸é…ç½®..."
          
          # æª¢æŸ¥å¿…è¦çš„ secrets
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "âŒ éŒ¯èª¤: OPENAI_API_KEY æœªè¨­ç½®"
            exit 1
          fi
          
          echo "âœ… å¿…è¦çš„ secrets å·²é…ç½®"
          
          # é¡¯ç¤ºä»»å‹™è³‡è¨Š
          echo "ğŸ“‹ ä»»å‹™è³‡è¨Š:"
          echo "  - Notion Page ID: ${{ github.event.client_payload.notion_page_id || github.event.inputs.notion_page_id }}"
          echo "  - ä»»å‹™åç¨±: ${{ github.event.client_payload.task_name || github.event.inputs.task_name }}"
          echo "  - å½±ç‰‡é€£çµ: ${{ github.event.client_payload.original_link || github.event.inputs.original_link }}"
          echo "  - è² è²¬äºº: ${{ github.event.client_payload.person_in_charge || github.event.inputs.person_in_charge || 'æœªæŒ‡å®š' }}"
          echo "  - æ”å½±å¸«: ${{ github.event.client_payload.videographer || github.event.inputs.videographer || 'æœªæŒ‡å®š' }}"
          echo "  - Whisper å•Ÿç”¨: ${{ github.event.client_payload.enable_whisper || github.event.inputs.enable_whisper || 'true' }}"
      
      # æ­¥é©Ÿ 6: å»ºç«‹ downloads ç›®éŒ„
      - name: Create downloads directory
        run: |
          mkdir -p downloads
          echo "ğŸ“ å»ºç«‹ downloads ç›®éŒ„å®Œæˆ"
      
      # æ­¥é©Ÿ 7: åŸ·è¡Œå¢å¼·ç‰ˆå½±ç‰‡è™•ç†
      - name: Run Enhanced Video Processor
        id: run-processor
        timeout-minutes: 35
        env:
          # Python ç’°å¢ƒè¨­å®š
          PYTHONPATH: .
          PYTHONUNBUFFERED: 1
          PYTHONDONTWRITEBYTECODE: 1
          
          # API Keys
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          
          # Notion é…ç½®
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          
          # R2 å„²å­˜è¨­å®š (å¯é¸ï¼Œå¤±æ•—æœƒè‡ªå‹•å‚™ä»½åˆ°æœ¬åœ°)
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_CUSTOM_DOMAIN: ${{ secrets.R2_CUSTOM_DOMAIN }}
          
          # ä»»å‹™åƒæ•¸
          NOTION_PAGE_ID: ${{ github.event.client_payload.notion_page_id || github.event.inputs.notion_page_id }}
          ORIGINAL_LINK: ${{ github.event.client_payload.original_link || github.event.inputs.original_link }}
          TASK_NAME: ${{ github.event.client_payload.task_name || github.event.inputs.task_name }}
          PERSON_IN_CHARGE: ${{ github.event.client_payload.person_in_charge || github.event.inputs.person_in_charge || '' }}
          VIDEOGRAPHER: ${{ github.event.client_payload.videographer || github.event.inputs.videographer || '' }}
          
          # å¢å¼·åŠŸèƒ½é–‹é—œ
          ENABLE_WHISPER: ${{ github.event.client_payload.enable_whisper || github.event.inputs.enable_whisper || 'true' }}
          ENABLE_LOCAL_BACKUP: ${{ github.event.client_payload.enable_local_backup || github.event.inputs.enable_local_backup || 'true' }}
          EXTRACT_FRAME: ${{ github.event.client_payload.extract_frame || github.event.inputs.extract_frame || 'true' }}
          
        run: |
          echo "ğŸƒâ€â™‚ï¸ é–‹å§‹å¢å¼·ç‰ˆå½±ç‰‡è™•ç†..."
          echo "â° é–‹å§‹æ™‚é–“: $(date)"
          
          # åŸ·è¡Œä¸»ç¨‹å¼
          python main.py
          
          # è¨˜éŒ„åŸ·è¡Œçµæœ
          EXIT_CODE=$?
          echo "â° çµæŸæ™‚é–“: $(date)"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… å½±ç‰‡è™•ç†æˆåŠŸå®Œæˆï¼"
          else
            echo "âŒ å½±ç‰‡è™•ç†å¤±æ•—ï¼Œé€€å‡ºç¢¼: $EXIT_CODE"
            exit $EXIT_CODE
          fi
      
      # æ­¥é©Ÿ 8: ä¸Šå‚³è™•ç†çµæœ (downloads è³‡æ–™å¤¾)
      - name: Upload processed files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processed-video-${{ github.run_id }}
          path: |
            downloads/
            logs/
          retention-days: 30
          if-no-files-found: warn
      
      # æ­¥é©Ÿ 9: æ¸…ç†æš«å­˜æª”æ¡ˆ
      - name: Clean up temporary files
        if: always()
        continue-on-error: true
        run: |
          echo "ğŸ§¹ æ¸…ç†æš«å­˜æª”æ¡ˆ..."
          
          # æ¸…ç† Python å¿«å–
          find . -type d -name "__pycache__" -delete 2>/dev/null || true
          find . -name "*.pyc" -delete 2>/dev/null || true
          
          # æ¸…ç†æš«å­˜æª”æ¡ˆ
          find . -name "*.tmp" -type f -delete 2>/dev/null || true
          find . -name "*.part" -type f -delete 2>/dev/null || true
          find . -name "video_pipeline_*" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "âœ… æ¸…ç†å®Œæˆ"
      
      # æ­¥é©Ÿ 10: ä¸Šå‚³å¤±æ•—æ—¥èªŒ
      - name: Upload failure logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs-${{ github.run_id }}
          path: |
            logs/
            *.log
            *.txt
            !requirements.txt
          retention-days: 7
          if-no-files-found: warn